<h1>Bundle Adjustment</h1>

<equation>
  \Argmin{\Tf{W}{C}, \Pt{W}{P}}
    \Norm{\Vec{z} - \boldsymbol{\pi}(\Tf{W}{C}^{-1} \enspace \Pt{W}{P})}^{2} \\
  % -- Project chain
  \boldsymbol{\pi} =
    \boldsymbol{k}(
    \boldsymbol{d}(
    \boldsymbol{p}(
      \Tf{W}{C}^{-1} \enspace \Pt{W}{P}
    )))  \\
</equation>

<p>
Useful skew properties:
<equation>
  \Skew{\Vec{v}}^{\transpose} &= -\Skew{\Vec{v}} \\
  \Skew{\Vec{v}}^{2}
    &= -\Vec{v}\Vec{v}^{\transpose}
      - \Vec{v}^{\transpose} \Vec{v} \I \\
  \Skew{\rot({\Phi}) \Vec{v}}
    &= \rot({\Phi}) \Skew{\Vec{v}} \rot({\Phi})^{\transpose}
</equation>
</p>



<h2>Project</h2>

<equation>
  % -- Project
  \Vec{x}
    &= \boldsymbol{p}(\Tf{W}{C}^{-1} \enspace \Pt{W}{P}) \\ 
    &= \boldsymbol{p}(\Pt{C}{P}) \\
    &= \begin{bmatrix}
      x / z \\
      y / z \\
    \end{bmatrix}
</equation>

<equation>
  \dfrac{\partial{\Vec{x}}}{\partial{\Pt{C}{P}}}
		&=
			\begin{bmatrix}
        1 / z & 0 & -x / z^{2} \\
				0 & 1 / z & -y / z^{2}
			\end{bmatrix}
</equation>


<h2>Radial-Tangential Distortion</h2>

<equation>
  x &= X / Z \\
  y &= Y / Z \\
  r^2 &= x^2 + y^2 \\ \\
  x' &= x \cdot (1 + (k_1 r^2) + (k_2 r^4)) \\
  y' &= y \cdot (1 + (k_1 r^2) + (k_2 r^4)) \\
  x'' &= x' + (2 p_1 x y + p_2 (r^2 + 2 x^2)) \\
  y'' &= y' + (p_1 (r^2 + 2 y^2) + 2 p_2 x y)
</equation>

<equation>
  \dfrac{\partial{\Vec{x}'}}{\partial{\Vec{x}}} &=
    \begin{bmatrix}
      J_{11} & J_{12} \\
      J_{21} & J_{22}
    \end{bmatrix} \\ \\
    J_{11} &= k_1 r^2 + k_2 r^4 + 2 p_1 y + 6 p_2 x
      + x (2 k_1 x + 4 k_2 x r^2) + 1 \\
    J_{12} &= 2 x p_1 + 2 y p_2 + y (2 k_1 x + 4 k_2 x r^2) \\
    J_{21} &= 2 x p_1 + 2 y p_2 + y (2 k_1 x + 4 k_2 x r^2) \\
    J_{22} &= k_1 r^2 + k_2 r^4 + 6 p_1 y + 2 p_2 x
      + y (2 k_1 y + 4 k_2 y r^2) + 1
</equation>

<equation>
  \dfrac{\partial{\Vec{x}'}}{\partial{\Vec{d}_{\text{params}}}} &=
    \begin{bmatrix}
      J_{11} & J_{12} & J_{13} & J_{14} \\
      J_{21} & J_{22} & J_{23} & J_{24}
    \end{bmatrix} \\ \\
    r^2 &= x^2 + y^2 \\ \\
    J_{11} &= x r^2 \\
    J_{12} &= x r^4 \\
    J_{13} &= 2 x y \\
    J_{14} &= 3 x^2 + y^2 \\ \\
    J_{21} &= y r^2 \\
    J_{22} &= y r^4 \\
    J_{23} &= x^2 + 3 y^2 \\
    J_{24} &= 2 x y
</equation>


<h2>Scale and Center</h2>

<equation>
  u = f_x \cdot x' + c_x \\
  v = f_y \cdot y' + c_y
</equation>

<equation>
  \dfrac{\partial\hat{\Vec{z}}}{\partial\Vec{x}'} &= \begin{bmatrix}
    f_x & 0 \\
    0 & f_y
  \end{bmatrix}
</equation>


<h2>Camera Pose $\Tf{W}{C}$</h2>

<equation>
  \Pt{C}{P} &= \Tf{W}{C}^{-1} \enspace \Pt{W}{P} \\
    &= \Rot{W}{C}^{-1} \enspace \Pt{W}{P} - \Rot{W}{C}^{-1} \Trans{W}{C}
</equation>

<equation>
  \dfrac{\partial{\Pt{C}{P}}}{\partial{\Tf{W}{C}}}
    &= \begin{bmatrix}
      \dfrac{\partial{\Pt{C}{P}}}{\partial{\quat_{WC}}}
			\qquad
      \dfrac{\partial{\Pt{C}{P}}}{\partial{\Trans{W}{C}}}
		\end{bmatrix}
</equation>

<equation>
  \dfrac{\partial{\Pt{C}{P}}}{\partial{\quat_{WC}^{-1}}}
    &= -\Skew{\Rot{W}{C}^{-1} \left( \Pt{W}{P} - \Trans{W}{C} \right)} \\
  \dfrac{\partial{\quat_{WC}^{-1}}}{\partial{\quat_{WC}}}
    &= -\Rot{W}{C}^{-1} \\ 
  \dfrac{\partial{\Pt{C}{P}}}{\partial{\quat_{WC}^{-1}}}
  \dfrac{\partial{\quat_{WC}^{-1}}}{\partial{\quat_{WC}}}
    &= (-\Skew{\Rot{W}{C}^{-1} \left( \Pt{W}{P} - \Trans{W}{C} \right)})
       (-\Rot{W}{C}^{-1}) \\ 
    &= (-\Rot{W}{C}^{-1} \Skew{\left( \Pt{W}{P} - \Trans{W}{C} \right)}
      \enspace \Rot{W}{C})(-\Rot{W}{C}^{-1}) & \text{using skew property}\\ 
    &= \Rot{W}{C}^{-1} \Skew{\left( \Pt{W}{P} - \Trans{W}{C} \right)} \\
    \\ \\
  \dfrac{\partial{\Pt{C}{P}}}{\partial{\Trans{W}{C}}}
    &= -\Rot{W}{C}^{-1}
</equation>

<equation>
\dfrac{\partial\hat{\Vec{z}}}{\partial\Vec{x}'}
  \dfrac{\partial\Vec{x}'}{\partial\Vec{x}}
  \dfrac{\partial\Vec{x}}{\partial\Pt{C}{P}}
  \dfrac{\partial{\Pt{C}{P}}}{\partial{\Tf{W}{C}}}
</equation>


<h2>Landmark $\Pt{W}{P}$</h2>

<equation>
  \Pt{C}{P} &= \Tf{W}{C}^{-1} \enspace \Pt{W}{P} \\
    &= \Rot{W}{C}^{-1} \enspace \Pt{W}{P} - \Rot{W}{C}^{-1} \Trans{W}{C}
</equation>

<equation>
  \dfrac{\partial\Pt{C}{P}}{\partial\Pt{W}{P}} &= \Rot{W}{C}^{-1} 
</equation>

<equation>
\dfrac{\partial\hat{\Vec{z}}}{\partial\Vec{x}'}
  \dfrac{\partial\Vec{x}'}{\partial\Vec{x}}
  \dfrac{\partial\Vec{x}}{\partial\Pt{C}{P}}
  \dfrac{\partial{\Pt{C}{P}}}{\partial{\Pt{W}{P}}}
</equation>

