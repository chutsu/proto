<h1>IMU Preintegration</h1>

<p>
<equation>
  \hat{\Vec{a}}_{S} &=
    \Vec{a}_{S} + \bias_{a} + \noise_{a} + \rot_{SW} \gravity \\
  \hat{\angvel}_{S} &=
    \angvel_{S} + \bias_{\omega} + \noise_{\omega}
</equation>

<equation>
  \trans_{WS_{k+1}}
    &= \trans_{WS_{k}}
      + \vel_{WS_{k}} \Delta t_{k}
      + \iint_{t \in [t_{k}, t_{k+1}]} (
      \rot_{WS} (\hat{\acc}_{S} - \bias_{a} - \noise_{a})
        - \gravity) dt^{2}
  \\
  \vel_{WS_{k+1}}
    &= \vel_{WS_{k}}
      + \int_{t \in [t_{k}, t_{k+1}]} (
      \rot_{WS} (\hat{\acc}_{S} - \bias_{a} - \noise_{a})
      - \gravity) dt
  \\
  \quat_{WS_{k+1}}
    &= \quat_{WS_{k}} \otimes
      \int_{t \in [t_{k}, t_{k+1}]}
      \dfrac{1}{2} \mathbf{\Omega}(
        \hat\angvel_{S} - \bias_{\omega} - \noise_{\omega}
        ) \quat_{S_{k}S_{t}} dt
</equation>
where
<equation>
  \mathbf{\Omega}(\mathbf{\omega}) =
    \begin{bmatrix}
      - \Skew{\omega} & \omega \\
      - \omega^{\transpose} & 0
    \end{bmatrix}, \enspace
  \Skew{\omega} =
    \begin{bmatrix}
      0 & -\omega_{z} & \omega_{y} \\
      \omega_{z} & 0 & -\omega_{x} \\
      -\omega_{y} & \omega_{x} & 0
    \end{bmatrix}.
</equation>
$\Delta{t_{k}}$ is the duration between the time interval $[t_k, t_{k+1}]$.</p>

<p>From the above it can be observed that the equations are a function of
position, velocity and orientation, which will change during optimization.
The IMU measurements $\hat{\Vec{a}}_{S}$ and $\hat{\angvel}_{S}$ will need be
reintegrated again to yeild a different position, velocity and orientation at
timestep $k$. To avoid reintegration the equations are re-written in such a way
the terms that will vary are factored out.</p>

<p>
First, we change the reference frames to a relative one by multiplying both
sides by $\rot_{S_{k}W}$
<equation>
  \rot_{S_{k}W} \trans_{WS_{k+1}}
    &= \rot_{S_{k}W} \left( 
        \trans_{WS_{k}} 
        + \vel_{WS_{k}} \Delta t_{k}
        - \dfrac{1}{2} \gravity \Delta{t}^{2}_{k}
      \right) + \boldsymbol{\alpha}_{k, k+1}
  \\
  \rot_{S_{k}W} \vel_{WS_{k+1}}
    &= \rot_{S_{k}W} (\vel_{WS_{k}} - \gravity \Delta{t}_{k})
    + \boldsymbol{\beta}_{k, k+1}
  \\
  \quat_{S_{k}W} \otimes \quat_{WS_{k+1}}
    &= \boldsymbol{\gamma}_{k, k+1}
</equation>
where
<equation>
  % Alpha
  \boldsymbol{\alpha}_{k, k+1} &=
    \iint_{t \in [t_{k}, t_{k+1}]} (
    \rot_{WS} (\hat{\acc}_{S} - \bias_{a} - \noise_{a})
    - \gravity) dt^{2} \\
  % Beta
  \boldsymbol{\beta}_{k, k+1} &=
      \int_{t \in [t_{k}, t_{k+1}]} (
      \rot_{WS} (\hat{\acc}_{S} - \bias_{a} - \noise_{a})
      - \gravity) dt \\
  % Gamma
  \boldsymbol{\gamma}_{k, k+1} &=
      \int_{t \in [t_{k}, t_{k+1}]}
      \dfrac{1}{2} \mathbf{\Omega}(
        \hat\angvel_{S} - \bias_{\omega} - \noise_{\omega}
      ) \boldsymbol{\gamma}_{t, k} dt
</equation>
</p>

<p>
The continuous-time linearized dynamics of error terms of
$\boldsymbol{\alpha}_{k, k+1}$, $\boldsymbol{\beta}_{k, k+1}$, and
$\boldsymbol{\gamma}_{k, k+1}$:
<equation>
\begin{bmatrix}
  \delta\dot{\boldsymbol{\alpha}}_{k, k+1} \\
  \delta\dot{\boldsymbol{\beta}}_{k, k+1} \\
  \delta\dot{\boldsymbol{\theta}}_{k, k+1} \\
  \delta\dot{\boldsymbol{\bias_{g}}}_{k, k+1} \\
  \delta\dot{\boldsymbol{\bias_{a}}}_{k, k+1} \\
\end{bmatrix}
=&
\begin{bmatrix}
  % Block line 1
  \Mat{0}_{3\times3} 
  & \Mat{I}_{3\times3} 
  & \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} \\
  % Block line 2
  \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} 
  & -\rot_{S_{k}S_{t}} \Skew{\hat{\acc}_{S, t} - \bias_{a, t}}
  & -\rot_{S_{k}S_{t}}
  & \Mat{0}_{3\times3} \\
  % Block line 3 
  \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} 
  & -\Skew{\hat{\gyr}_{S, t} - \bias_{w, t}}
  & \Mat{0}_{3\times3} 
  & \I_{3\times3} \\
  % Block line 4
  \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} \\
  % Block line 5 
  \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3}
\end{bmatrix}
\begin{bmatrix}
  \delta\boldsymbol{\alpha}_{k, k+1} \\
  \delta\boldsymbol{\beta}_{k, k+1} \\
  \delta\boldsymbol{\theta}_{k, k+1} \\
  \delta\boldsymbol{\bias_{g}}_{k, k+1} \\
  \delta\boldsymbol{\bias_{a}}_{k, k+1} \\
\end{bmatrix} \\
&+
\begin{bmatrix}
  % Row Block 1
  \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} \\
  % Row Block 2
  -\rot_{S_{k} t} 
  & \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} \\
  % Row Block 3
  \Mat{0}_{3\times3} 
  & -\I_{3\times3} 
  & \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} \\
  % Row Block 4
  \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} 
  & \I_{3\times3}
  & \Mat{0}_{3\times3} \\
  % Row Block 5
  \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} 
  & \Mat{0}_{3\times3} 
  & \I_{3\times3} \\
\end{bmatrix}
\begin{bmatrix}
  \boldsymbol{\noise_{a}} \\
  \boldsymbol{\noise_{w}} \\
  \boldsymbol{\noise_{\bias_{a}}} \\
  \boldsymbol{\noise_{\bias_{w}}}
\end{bmatrix}
</equation>

<equation>
  \delta\dot{\Vec{x}}_{t} &= \Mat{F}_{t} \delta\Vec{x}_{t} + \Mat{G}_{t} \noise_{t} \\
  \Mat{P} &= (\I + \Mat{F}_{t} \delta{t}) \Mat{P} (\I + \Mat{F}_{t} \delta{t})^{\transpose}
    + (\Mat{G}_{t} \delta{t}) \Mat{Q} (\Mat{G}_{t} \delta{t})^{\transpose} \\
  \Mat{J}_{t + \delta{t}}  &= (\I + \Mat{F}_{t} \delta{t}) \Mat{J}_{t}
</equation>
where $\Mat{Q}$ is the diagonal covariance matrix of noise.

<equation>
  % Row block 1
  \boldsymbol{\alpha}_{k, k+1} &\approx
    \boldsymbol{\hat\alpha}_{k, k+1} 
    + \Mat{J}^{\boldsymbol{\alpha}}_{\bias_{a}} \delta{\bias_{a, k}}
    + \Mat{J}^{\boldsymbol{\alpha}}_{\bias_{w}} \delta{\bias_{w, k}} \\
  % Row block 2
  \boldsymbol{\beta}_{k, k+1} &\approx
    \boldsymbol{\hat\beta}_{k, k+1} 
    + \Mat{J}^{\boldsymbol{\beta}}_{\bias_{a}} \delta{\bias_{a, k}}
    + \Mat{J}^{\boldsymbol{\beta}}_{\bias_{w}} \delta{\bias_{w, k}} \\
  % Row block 3
  \boldsymbol{\gamma}_{k, k+1} &\approx
    \boldsymbol{\hat\gamma}_{k, k+1} \otimes
    \begin{bmatrix}
      1 \\
      \dfrac{1}{2} \Mat{J}^{\gamma}_{\bias_{w}} \delta{\bias_{w, t}}
    \end{bmatrix}
</equation>

<equation>
\begin{bmatrix}
  \boldsymbol{\hat\alpha}_{k, k+1} \\
  \boldsymbol{\hat\beta}_{k, k+1} \\
  \boldsymbol{\hat\gamma}_{k, k+1} \\
  \Mat{0} \\
  \Mat{0}
\end{bmatrix}
=
\begin{bmatrix}
  % Row block 1
  \rot_{S_{k}W}(
    \pos_{WS_{k + 1}} - \pos_{WS_{k}}
    + \dfrac{1}{2} \gravity \Delta{t}^{2}_{k}
    - \vel_{WS_{k}} \Delta{t}_{k}
  ) \\
  % Row block 2
  \rot_{S_{k}W}(
    \pos_{WS_{k + 1}} - \pos_{WS_{k}}
    + \gravity \Delta{t}^{2}_{k}
    - \vel_{WS_{k}}
  ) \\
  % Row block 3
  \quat^{-1}_{WS_{k}} \otimes \quat^{-1}_{WS_{k + 1}} \\
  % Row block 4
  \bias_{a, k + 1} - \bias_{a, k} \\
  % Row block 5
  \bias_{w, k + 1} - \bias_{w, k} \\
\end{bmatrix}
</equation>

<equation>
\begin{bmatrix}
  \delta\boldsymbol{\alpha}_{k, k+1} \\
  \delta\boldsymbol{\beta}_{k, k+1} \\
  \delta\boldsymbol{\theta}_{k, k+1} \\
  \delta\bias_{a_{k, k+1}} \\
  \delta\bias_{g_{k, k+1}}
\end{bmatrix}
&=
\begin{bmatrix}
  % Row block 1
  \rot_{S_{k}W}(
    \pos_{WS_{k + 1}} - \pos_{WS_{k}}
    + \dfrac{1}{2} \gravity \Delta{t}^{2}_{k}
    - \vel_{WS_{k}} \Delta{t}_{k}
  ) - \hat\boldsymbol{\alpha}_{k, k + 1} \\
  % Row block 2
  \rot_{S_{k}W}(
    \vel_{WS_{k + 1}}
    + \gravity \Delta{t}_{k}
    - \vel_{WS_{k}}
  ) - \hat\boldsymbol{\beta}_{k, k + 1} \\
  % Row block 3
  2 \begin{bmatrix}
    \quat^{-1}_{WS_{k}}
    \otimes \quat_{WS_{k + 1}}
    \otimes (\boldsymbol{\hat\gamma}_{k, k+1})^{-1}
  \end{bmatrix}_{xyz} \\
  % Row block 4
  \bias_{a, k + 1} - \bias_{a, k} \\
  % Row block 5
  \bias_{w, k + 1} - \bias_{w, k} \\
\end{bmatrix}
</equation>

<equation>
  % Jacobian of residual w.r.t. state k
  \dfrac{\partial\Vec{r}}{\partial\delta{x}_{k}} 
  &= \begin{bmatrix}
  % -- Row block 1
  -\rot_{k, 0} 
  & -\Delta{t} \I_{3 \times 3} 
  & \Skew{\rot_{k, 0} (
    \pos_{WS_{k + 1}} - \pos_{WS_{k}}
    + \dfrac{1}{2} \gravity \Delta{t}^{2}
  )} \\
  & 
  % -- Row block 2
  \Mat{0}_{3 \times 3}
  & -\I_{3 \times 3}
  & \Skew{\rot_{k, 0} (
    \rot_{0, k + 1} \vel_{WS_{k + 1}}
    + \gravity \Delta{t}
  )} \\
  % -- Row block 3
  \Mat{0}_{3 \times 3}
  & \Mat{0}_{3 \times 3}
  & -\rot_{k+1, 0} \rot_{0, k}
  \end{bmatrix} \\
  % Jacobian of residual w.r.t. state k+1
  \dfrac{\partial\Vec{r}}{\partial\delta{x}_{k + 1}}
  &= \begin{bmatrix}
    % -- Row block 1
    \rot_{S_{k}W} 
    & \Mat{0}_{3 \times 3} 
    & \Mat{0}_{3 \times 3} \\
    % -- Row block 2
    \Mat{0}_{3 \times 3} 
    & \rot_{S_{k}W} \rot_{WS_{k+1}} 
    & \rot_{S_{k}W} \rot_{WS_{k+1}} \Skew{\vel_{k + 1}} \\
    % -- Row block 3
    \Mat{0}_{3 \times 3} 
    & \Mat{0}_{3 \times 3} 
    & \I_{3 \times 3}
  \end{bmatrix}
</equation>
</p>
